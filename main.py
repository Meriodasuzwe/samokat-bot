import logging
import pprint
import os
import json
import sys

from dotenv import load_dotenv
from telegram import (
    Update, ReplyKeyboardMarkup, KeyboardButton,
    InlineKeyboardMarkup, InlineKeyboardButton
)
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters, ConversationHandler, CallbackQueryHandler
)
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime

# ==== –õ–û–ì–ò ====
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler("railway.log")
    ]
)
logger = logging.getLogger(__name__)

# ==== –ù–ê–°–¢–†–û–ô–ö–ò ====
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
ADMIN_IDS = [5092137530, 570326525]
CHANNEL_ID = "@SamokatControlAstana"

# ==== GOOGLE SHEETS ====
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds_json = json.loads(os.getenv("GOOGLE_CREDENTIALS"))
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_json, scope)
gc = gspread.authorize(creds)
sheet = gc.open("Samokat Complaints").sheet1

# ==== –≠—Ç–∞–ø—ã FSM ====
MENU, OPERATOR, LOCATION, MEDIA, DESCRIPTION = range(5)

# ==== –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ====
main_menu = ReplyKeyboardMarkup(
    [["üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É", "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"], ["‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ"]],
    resize_keyboard=True
)

operator_kb = ReplyKeyboardMarkup(
    [["Whoosh", "Yandex", "Jet", "–ù–µ –∑–Ω–∞—é"], ["üîô –ù–∞–∑–∞–¥"]],
    resize_keyboard=True
)

location_kb = ReplyKeyboardMarkup(
    [[KeyboardButton("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é", request_location=True)], ["üîô –ù–∞–∑–∞–¥"]],
    resize_keyboard=True
)

after_report_kb = ReplyKeyboardMarkup(
    [["üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–Ω—É –∂–∞–ª–æ–±—É", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]],
    resize_keyboard=True
)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∂–∞–ª–æ–± –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
pending = {}
reject_pending = {}  # –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∂–∞–ª–æ–±, –æ–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

# ==== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ====

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message:
        return MENU
    await update.message.reply_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!", reply_markup=main_menu)
    return MENU

async def menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if text == "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É":
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:", reply_markup=operator_kb)
        return OPERATOR

    if text == "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å":
        user = update.effective_user
        data = sheet.get_all_records()

        count = sum(1 for r in data if r["User"] == user.username or r["User"] == user.first_name)

        profile_text = (
            f"üë§ –ü—Ä–æ—Ñ–∏–ª—å @{user.username or user.first_name}\n"
            f"–ñ–∞–ª–æ–± –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {count}\n"
            f"–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
        )

        await update.message.reply_text(profile_text, reply_markup=main_menu)
        return MENU

    if text == "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ":
        await update.message.reply_text(
            "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏ —ç–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç–æ–≤ –≤ –ê—Å—Ç–∞–Ω–µ.",
            reply_markup=main_menu
        )
        return MENU

    if text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        return await start(update, context)

    if text == "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–Ω—É –∂–∞–ª–æ–±—É":
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:", reply_markup=operator_kb)
        return OPERATOR

    return MENU

async def get_operator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text == "üîô –ù–∞–∑–∞–¥":
        return await start(update, context)
    context.user_data["operator"] = update.message.text
    await update.message.reply_text("üìç –£–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é:", reply_markup=location_kb)
    return LOCATION

async def get_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text == "üîô –ù–∞–∑–∞–¥":
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:", reply_markup=operator_kb)
        return OPERATOR

    if update.message.location:
        loc = update.message.location
        context.user_data["location"] = f"{loc.latitude}, {loc.longitude}"
    else:
        context.user_data["location"] = update.message.text

    await update.message.reply_text("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è:")
    return MEDIA

async def get_media(update: Update, context: ContextTypes.DEFAULT_TYPE):
    media = update.message.photo[-1].file_id if update.message.photo else update.message.video.file_id
    context.user_data["media"] = media
    context.user_data["media_type"] = "photo" if update.message.photo else "video"

    await update.message.reply_text("‚úèÔ∏è –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ó–∞–Ω—è–ª–∏ —Ç—Ä–æ—Ç—É–∞—Ä –≤–æ–∑–ª–µ –¢–¶¬ª):")
    return DESCRIPTION

async def get_description(update: Update, context: ContextTypes.DEFAULT_TYPE):
    description = update.message.text
    user = update.effective_user
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Google Sheets
    row = [
        now,
        user.username or user.first_name,  # User (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
        context.user_data["operator"],
        context.user_data["location"],
        context.user_data["media"],
        "–æ–∂–∏–¥–∞–µ—Ç",
        description,  # Description
        ""            # Moderator Comment (–ø—É—Å—Ç–æ–µ –ø–æ–∫–∞)
    ]
    sheet.append_row(row)

    # –°–æ–∑–¥–∞—ë–º ID –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    msg_id = update.message.message_id
    pending[msg_id] = {
        "user_id": user.id,
        "operator": context.user_data["operator"],
        "location": context.user_data["location"],
        "media": context.user_data["media"],
        "media_type": context.user_data["media_type"],
        "description": description
    }

    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    kb = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm:{msg_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject:{msg_id}")
        ]
    ])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º
    text = (
        f"–ù–æ–≤–∞—è –∂–∞–ª–æ–±–∞\n"
        f"üõ¥ {context.user_data['operator']}\n"
        f"üìç {context.user_data['location']}\n"
        f"üìù {description}"
    )
    for admin in ADMIN_IDS:
        await context.bot.send_message(admin, text, reply_markup=kb)
        if context.user_data["media_type"] == "photo":
            await context.bot.send_photo(admin, context.user_data["media"])
        else:
            await context.bot.send_video(admin, context.user_data["media"])

    await update.message.reply_text(
        "‚úÖ –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
        reply_markup=after_report_kb
    )
    return MENU

# ====== –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ======
async def confirm_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id

    if user_id not in ADMIN_IDS:
        await query.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤.", show_alert=True)
        return

    if not query.data.startswith("confirm:"):
        return
    msg_id = int(query.data.split(":")[1])
    comp = pending.pop(msg_id, None)
    if not comp:
        await query.edit_message_text("‚ùó –ñ–∞–ª–æ–±–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞.")
        return

    # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Google Sheets
    rows = sheet.get_all_values()
    for i, row in enumerate(rows, start=1):
        if row[4] == comp["media"]:
            sheet.update_cell(i, 6, "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ")
            break

    caption = (
        f"üö® –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –∂–∞–ª–æ–±–∞\n"
        f"üõ¥ {comp['operator']}\n"
        f"üìç {comp['location']}\n"
        f"üìù {comp['description']}"
    )
    if comp["media_type"] == "photo":
        await context.bot.send_photo(CHANNEL_ID, comp["media"], caption=caption)
    else:
        await context.bot.send_video(CHANNEL_ID, comp["media"], caption=caption)

    await context.bot.send_message(comp["user_id"], "‚úÖ –í–∞—à–∞ –∂–∞–ª–æ–±–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!")
    await query.edit_message_text("‚úÖ –ñ–∞–ª–æ–±–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞.")

# ====== –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ======
async def reject_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id

    if user_id not in ADMIN_IDS:
        await query.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤.", show_alert=True)
        return

    msg_id = int(query.data.split(":")[1])
    comp = pending.pop(msg_id, None)
    if not comp:
        await query.edit_message_text("‚ùó –ñ–∞–ª–æ–±–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞.")
        return

    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
    reject_pending[user_id] = comp
    await query.edit_message_text("‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å? –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–µ–º.")

# ====== –ü—Ä–∏—ë–º –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è ======
async def reject_reason(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id not in reject_pending:
        return  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ –∂–¥—ë–º –ø—Ä–∏—á–∏–Ω—É

    comp = reject_pending.pop(user_id)
    reason = update.message.text

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Google Sheets
    rows = sheet.get_all_values()
    for i, row in enumerate(rows, start=1):
        if row[4] == comp["media"]:
            sheet.update_cell(i, 6, "–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ")        # Status
            sheet.update_cell(i, 8, reason)             # Moderator Comment
            break

    await context.bot.send_message(comp["user_id"], f"‚ùå –í–∞—à–∞ –∂–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –ü—Ä–∏—á–∏–Ω–∞: {reason}")
    await update.message.reply_text("–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∏ –ø—Ä–∏—á–∏–Ω–∞ –∑–∞–ø–∏—Å–∞–Ω–∞.")

# ==== –ó–ê–ü–£–°–ö ====
app = ApplicationBuilder().token(TOKEN).build()

conv = ConversationHandler(
    entry_points=[CommandHandler("start", start)],
    states={
        MENU: [MessageHandler(filters.TEXT & ~filters.COMMAND, menu_handler)],
        OPERATOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_operator)],
        LOCATION: [MessageHandler((filters.TEXT | filters.LOCATION) & ~filters.COMMAND, get_location)],
        MEDIA: [MessageHandler(filters.PHOTO | filters.VIDEO, get_media)],
        DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_description)]
    },
    fallbacks=[CommandHandler("cancel", start)]
)

app.add_handler(conv)
app.add_handler(CallbackQueryHandler(confirm_handler, pattern="^confirm:"))
app.add_handler(CallbackQueryHandler(reject_handler, pattern="^reject:"))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, reject_reason))

if __name__ == "__main__":
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.")
    app.run_polling(close_loop=False)
